<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJJæé†’ğŸ˜‹</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="shortcut icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- åœ¨bodyå¼€å§‹å¤„æ·»åŠ å¯†ç éªŒè¯å±‚ -->
    <div id="password-overlay" class="password-overlay">
        <div class="password-container">
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç ">
            <button onclick="verifyPassword()">ç¡®è®¤</button>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <div class="title-wrapper">
                <a href="https://hugo.aliya.us.kg/" class="logo-link" target="_blank" rel="noopener noreferrer">
                    <img src="logo.png" alt="ç½‘ç«™Logo" class="logo">
                </a>
                <h1>MJJæé†’ğŸ˜‹</h1>
            </div>
            <button id="openAddForm" class="add-button">ğŸ“‘æ·»åŠ æ–°æé†’</button>
        </div>
        <div class="total-expenses-card">
            <div class="expense-item">
                <p class="expense-title">æœˆåº¦æ€»æ”¯å‡º</p>
                <p class="expense-value" id="totalMonthly">0</p>
            </div>
            <div class="divider"></div>
            <div class="expense-item">
                <p class="expense-title">å¹´åº¦æ€»æ”¯å‡º</p>
                <p class="expense-value" id="totalYearly">0</p>
            </div>
            <div class="divider"></div>
            <div class="expense-item">
                <p class="expense-title">æœåŠ¡å™¨æ•°é‡</p>
                <p class="expense-value" id="totalMachine">0</p>
            </div>
        </div>

        <!-- å‡ºå¼æ·»åŠ æé†’è¡¨å• -->
        <div id="addFormModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>â•æ·»åŠ æ–°æé†’</h2>
                    <span class="close">&times;</span>
                </div>
                <form id="reminderForm">
                    <div class="form-group">
                        <label for="title">ğŸªªé¡¹ç›®åç§°:</label>
                        <input type="text" id="title" required>
                    </div>
                    <div class="form-group">
                        <label for="link">ğŸ“Œé“¾æ¥åœ°å€:</label>
                        <input type="url" id="link" placeholder="å¯é€‰ï¼Œä¾‹å¦‚: https://example.com">
                    </div>
                    <div class="form-group full-width">
                        <label for="content">ğŸ”–é¡¹ç›®å†…å®¹:</label>
                        <textarea id="content" required></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="remindTime">â°æé†’æ—¶é—´:</label>
                        <div class="time-shortcuts">
                            <button type="button" class="time-shortcut-btn" onclick="setQuickTime(3)">3åˆ†é’Ÿå</button>
                            <button type="button" class="time-shortcut-btn" onclick="setQuickTime(15)">15åˆ†é’Ÿå</button>
                            <button type="button" class="time-shortcut-btn" onclick="setQuickTime(30)">30åˆ†é’Ÿå</button>
                            <button type="button" class="time-shortcut-btn" onclick="setQuickTime(60)">1å°æ—¶å</button>
                            <button type="button" class="time-shortcut-btn" onclick="setQuickTime(120)">2å°æ—¶å</button>
                            <button type="button" class="time-shortcut-btn" onclick="setTomorrowMorning()">æ˜æ—©9ç‚¹</button>
                            <button type="button" class="time-shortcut-btn" onclick="setTomorrowNoon()">æ˜å¤©ä¸­åˆ12ç‚¹</button>
                            <button type="button" class="time-shortcut-btn" onclick="setDaysLater(6)">6å¤©å</button>
                            <button type="button" class="time-shortcut-btn" onclick="setDaysLater(29)">29å¤©å</button>
                            <button type="button" class="time-shortcut-btn" onclick="setDaysLater(364)">364å¤©å</button>
                        </div>
                        <input type="datetime-local" id="remindTime" required>
                    </div>
                    <div class="form-group">
                        <label for="cycleType">ğŸ”å¾ªç¯ç±»å‹:</label>
                        <select id="cycleType" required>
                            <option value="once">å•æ¬¡æé†’</option>
                            <option value="weekly">æ¯å‘¨å¾ªç¯</option>
                            <option value="monthly">æ¯æœˆå¾ªç¯</option>
                            <option value="yearly">æ¯å¹´å¾ªç¯</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="currency">ğŸ’±å¸ç§:</label>
                        <select id="currency">
                            <option value="CNY">CNY (äººæ°‘å¸)</option>
                            <option value="USD">USD (ç¾å…ƒ)</option>
                            <option value="EUR">EUR (æ¬§å…ƒ)</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="amount">ğŸ’°é‡‘é¢:</label>
                        <input type="number" id="amount" placeholder="è¯·è¾“å…¥é‡‘é¢" step="0.01">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">æ·»åŠ æé†’</button>
                        <button type="button" class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æé†’åˆ—è¡¨ -->
        <div class="reminders-grid" id="remindersList"></div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤çª—å£ -->
    <div id="confirmModal" class="modal confirm-modal">
        <div class="modal-content confirm-content">
            <div class="modal-header">
                <h2>ç¡®è®¤æ“ä½œ</h2>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeConfirmModal(false)">å–æ¶ˆ</button>
                <button class="confirm-btn" onclick="closeConfirmModal(true)">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¡ -->
    <div id="toast" class="toast">
        <div class="toast-content">
            <svg class="toast-icon success" viewBox="0 0 1024 1024" width="16" height="16">
                <path
                    d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm193.5 301.7l-210.6 292a31.8 31.8 0 0 1-51.7 0L318.5 484.9c-3.8-5.3 0-12.7 6.5-12.7h46.9c10.2 0 19.9 4.9 25.9 13.3l71.2 98.8 157.2-218c6-8.3 15.6-13.3 25.9-13.3H699c6.5 0 10.3 7.4 6.5 12.7z" />
            </svg>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <script>
        // å®šä¹‰å…¨å±€å˜é‡å­˜å‚¨æ±‡ç‡å’Œæœ€åè·å–æ—¶é—´
        let exchangeRates = {};
        let lastFetchTime = null;
        function getCurrentDate() {
            const now = new Date();
            return now.toISOString().split('T')[0];
        }

        // è·å–å®æ—¶æ±‡ç‡çš„å‡½æ•°
        // è·å–å®æ—¶æ±‡ç‡ï¼ˆä»…åœ¨æ¯å¤©ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œï¼‰
        function fetchExchangeRates() {
            const today = getCurrentDate();

            // å¦‚æœå½“å¤©å·²è·å–è¿‡æ±‡ç‡ï¼Œç›´æ¥è¿”å›
            if (lastFetchTime === today) {
                console.log('[INFO] ä½¿ç”¨ç¼“å­˜çš„æ±‡ç‡:', exchangeRates);
                return;
            }

            // å‘èµ·ç½‘ç»œè¯·æ±‚è·å–æ±‡ç‡
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://v6.exchangerate-api.com/v6/d0705f1a65d2749fc5936275/latest/CNY', false); // false -> åŒæ­¥è¯·æ±‚
            xhr.send(null);

            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                if (data.result === 'success') {
                    exchangeRates = data.conversion_rates; // ç¼“å­˜æ±‡ç‡
                    lastFetchTime = today; // æ›´æ–°è·å–æ—¶é—´
                    console.log('[SUCCESS] å®æ—¶æ±‡ç‡å·²æ›´æ–°:', exchangeRates);
                }
            } else {
                console.error('[ERROR] æ— æ³•è·å–æ±‡ç‡ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                exchangeRates = { USD: 7.3, EUR: 7.8, CNY: 1 }; // ä½¿ç”¨é»˜è®¤æ±‡ç‡
            }
        }
        // å¿«é€Ÿæ—¶é—´è®¾ç½®å‡½æ•°
        function setQuickTime(minutes) {
            const now = new Date();
            const futureTime = new Date(now.getTime() + minutes * 60000);
            // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºdatetime-localæ ¼å¼
            const formattedDateTime = formatDateTimeForInput(futureTime);
            document.getElementById('remindTime').value = formattedDateTime;
        }

        function setTomorrowMorning() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);
            document.getElementById('remindTime').value = formatDateTimeForInput(tomorrow);
        }

        function setTomorrowNoon() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(12, 0, 0, 0);
            document.getElementById('remindTime').value = formatDateTimeForInput(tomorrow);
        }

        function setDaysLater(days) {
            const now = new Date();
            const futureTime = new Date(now.getTime() + days * 24 * 60 * 60 * 1000);
            // ä¿æŒå½“å‰æ—¶é—´
            futureTime.setHours(now.getHours());
            futureTime.setMinutes(now.getMinutes());
            document.getElementById('remindTime').value = formatDateTimeForInput(futureTime);
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ä¸ºdatetime-localè¾“å…¥æ¡†æ ¼å¼
        function formatDateTimeForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // å°†é‡‘é¢è½¬æ¢ä¸ºäººæ°‘å¸
        function convertToRMB(amount, currency) {
            // ç¡®ä¿å·²è·å–æ±‡ç‡
            fetchExchangeRates();

            const rate = exchangeRates[currency] || 1; // è·å–æ±‡ç‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ 1
            console.log('[SUCCESS] rate:', exchangeRates);
            return parseFloat((amount / rate).toFixed(2)); // è¿”å›æµ®ç‚¹æ•°
        }

        function calculateTotalExpenses(reminders) {
            let totalMonthly = 0;
            let totalYearly = 0;

            let totalMachine = 0;
            reminders.forEach(reminder => {
                totalMachine++;

                const amountInRMB = convertToRMB(reminder.amount, reminder.currency);
                if (reminder.cycle_type === 'monthly') {
                    totalMonthly += amountInRMB;
                    totalYearly += amountInRMB * 12;

                } else if (reminder.cycle_type === 'yearly') {
                    totalMonthly += parseFloat((amountInRMB / 12).toFixed(2));
                    totalYearly += amountInRMB;
                }
            });

            document.getElementById('totalMonthly').textContent = `Â¥${totalMonthly.toFixed(2)}`;
            document.getElementById('totalYearly').textContent = `Â¥${totalYearly.toFixed(2)}`;
            document.getElementById('totalMachine').textContent = reminders.length;
        }

        // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚åº”å½“å‰åŸŸå
        const API_BASE = '/api/reminders';

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDateTime(date) {
            const d = new Date(date);
            // ä½¿ç”¨æ—¶é—´æˆ³å‡å»8å°æ—¶ï¼ˆ8 * 60 * 60 * 1000 æ¯«ç§’ï¼‰
            const adjustedDate = new Date(d.getTime() - 8 * 60 * 60 * 1000);
            return adjustedDate.toLocaleString('zh-CN');
        }

        // è½¬æ¢æœ¬åœ°æ—¶é—´ä¸ºUTCæ—¶é—´
        function localToUTC(dateString) {
            const date = new Date(dateString);
            return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString();
        }

        // è‡ªå®šä¹‰ç¡®è®¤çª—å£
        let confirmResolve = null;

        function showConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const messageEl = document.getElementById('confirmMessage');
                messageEl.textContent = message;
                modal.style.display = 'block';
                confirmResolve = resolve;
            });
        }

        function closeConfirmModal(result) {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            if (confirmResolve) {
                confirmResolve(result);
                confirmResolve = null;
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¡
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toast.querySelector('.toast-icon');

            toastMessage.textContent = message;
            toast.className = `toast show ${type}`;
            icon.className = `toast-icon ${type}`;

            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // åˆ é™¤æé†’
        async function deleteReminder(id, cronJobId) {
            const confirmed = await showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæé†’å—ï¼Ÿ');
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ cronJobId })
                });

                if (response.ok) {
                    showToast('æé†’åˆ é™¤æˆåŠŸï¼');
                    loadReminders();
                } else {
                    const error = await response.text();
                    throw new Error(error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('åˆ é™¤æé†’å¤±è´¥ï¼š' + error.message, 'error');
            }
        }


        // æ·»åŠ æé†’
        async function addReminder(event) {
            event.preventDefault();

            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const remindTime = document.getElementById('remindTime').value;
            const cycleType = document.getElementById('cycleType').value;
            const link = document.getElementById('link').value;
            const amount = parseFloat(document.getElementById('amount').value || '0');
            const currency = document.getElementById('currency').value;

            const amountInRMB = convertToRMB(amount, currency);
            const monthlyAmount = cycleType === 'monthly' ? amountInRMB : 0;
            const yearlyAmount = cycleType === 'yearly' ? amountInRMB : monthlyAmount * 12;

            const reminder = {
                id: Date.now().toString(),
                title,
                content,
                remind_time: localToUTC(remindTime),
                cycle_type: cycleType,
                status: 0,
                link: link || '#',
                amount,
                currency,
                monthly_amount: monthlyAmount,
                yearly_amount: yearlyAmount,
            };

            // Send reminder to backend
            try {
                const response = await fetch('/api/reminders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reminder),
                });

                if (response.ok) {
                    showToast('æé†’æ·»åŠ æˆåŠŸï¼');
                    closeModal();
                    loadReminders();
                } else {
                    throw new Error('æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                console.error(error);
                showToast('æ·»åŠ æé†’å¤±è´¥', 'error');
            }
        }


        // è®¡ç®—ä¸‹ä¸€æ¬¡æé†’æ—¶é—´
        function calculateNextRemindTime(currentTime, cycleType) {
            const date = new Date(currentTime);
            const timestamp = date.getTime();

            // è®¡ç®—å„ä¸ªå‘¨æœŸçš„æ¯«ç§’
            const DAY_MS = 24 * 60 * 60 * 1000;
            const WEEK_MS = 7 * DAY_MS;

            switch (cycleType) {
                case 'weekly':
                    return new Date(timestamp + WEEK_MS);
                case 'monthly': {
                    // è·å–å½“å‰æœˆä»½çš„å¤©æ•°
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const day = date.getDate();
                    const hour = date.getHours();
                    const minute = date.getMinutes();
                    const second = date.getSeconds();

                    // åˆ›å»ºä¸‹ä¸ªæœˆçš„åŒä¸€å¤©
                    let nextDate = new Date(year, month + 1, day, hour, minute, second);

                    // å¦‚æœç»“æœæ˜¯æ— æ•ˆæ—¥æœŸï¼ˆæ¯”å¦‚ 1æœˆ31æ—¥ -> 2æœˆ31æ—¥ï¼‰ï¼Œå›é€€åˆ°æœˆåº•
                    if (nextDate.getMonth() !== (month + 1) % 12) {
                        nextDate = new Date(year, month + 2, 0, hour, minute, second); // è®¾ç½®ä¸ºä¸‹ä¸ªæœˆçš„æœ€åä¸€å¤©
                    }

                    return nextDate;
                }
                case 'yearly': {
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const day = date.getDate();
                    const hour = date.getHours();
                    const minute = date.getMinutes();
                    const second = date.getSeconds();

                    // åˆ›å»ºæ˜å¹´çš„åŒä¸€å¤©
                    let nextDate = new Date(year + 1, month, day, hour, minute, second);

                    // å¤„ç†2æœˆ29æ—¥çš„ç‰¹æ®Šæƒ…å†µ
                    if (month === 1 && day === 29 && !isLeapYear(year + 1)) {
                        nextDate = new Date(year + 1, 1, 28, hour, minute, second);
                    }

                    return nextDate;
                }
                default:
                    return null;
            }
        }

        // åˆ¤æ–­æ˜¯å¦é—°å¹´
        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        // åŠ è½½æé†’åˆ—è¡¨
        async function loadReminders() {
            try {
                const response = await fetch(API_BASE);
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'åŠ è½½å¤±è´¥');
                }
                const reminders = await response.json();
                calculateTotalExpenses(reminders);

                const listElement = document.getElementById('remindersList');
                listElement.innerHTML = '';



                reminders.sort((a, b) => new Date(a.remind_time) - new Date(b.remind_time));
                reminders.forEach(reminder => {
                    const cycleText = {
                        'once': 'å•æ¬¡æé†’',
                        'weekly': 'æ¯å‘¨å¾ªç¯',
                        'monthly': 'æ¯æœˆå¾ªç¯',
                        'yearly': 'æ¯å¹´å¾ªç¯'
                    }[reminder.cycle_type] || 'å•æ¬¡æé†’';
                    const amount = convertToRMB(reminder.amount, reminder.currency);
                    const monthlyAmount = reminder.cycle_type === 'monthly' ? amount : parseFloat((amount / 12).toFixed(2));
                    const yearlyAmount = reminder.cycle_type === 'yearly' ? amount : monthlyAmount * 12;

                    // è®¡ç®—ä¸‹ä¸€æ¬¡æé†’æ—¶é—´
                    let nextRemindTime = null;
                    const currentTime = new Date(reminder.remind_time);
                    const now = new Date();

                    if (reminder.status === 1 && reminder.cycle_type !== 'once') {
                        nextRemindTime = calculateNextRemindTime(reminder.remind_time, reminder.cycle_type);
                    }

                    const reminderElement = document.createElement('div');
                    reminderElement.className = `card-container theme-${reminder.cycle_type}`;
                    reminderElement.innerHTML = `
                        <div class="dashed-border"></div>
                        <div class="reminder-card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="type-icon ${reminder.cycle_type}">
                                        ${reminder.cycle_type === 'once' ? `
                                            <svg viewBox="0 0 1024 1024" width="20" height="20">
                                                <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
                                                <path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"/>
                                            </svg>
                                        ` : reminder.cycle_type === 'weekly' ? `
                                            <svg viewBox="0 0 1024 1024" width="20" height="20">
                                                <path d="M112 880c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V460H112v420zm768-696H712v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H384v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H144c-17.7 0-32 14.3-32 32v176h800V216c0-17.7-14.3-32-32-32z"/>
                                            </svg>
                                        ` : reminder.cycle_type === 'monthly' ? `
                                            <svg viewBox="0 0 1024 1024" width="20" height="20">
                                                <path d="M512 832c-176.448 0-320-143.552-320-320S335.552 192 512 192c23.232 0 45.888 2.56 67.84 7.232a2.4832 2.4832 0 0 1 1.984 2.816 3.3792 3.3792 0 0 1-.512 1.408C560.512 242.688 548.288 287.744 548.288 336c0 189.632 153.088 343.36 341.952 345.088 1.088.064 2.048.768 2.56 1.792s.448 2.24-.256 3.136C815.36 772.672 670.784 832 512 832zM512 256c-141.152 0-256 114.848-256 256s114.848 256 256 256c117.632 0 217.088-79.36 246.912-189.248C609.472 547.968 516.032 454.528 484.288 305.088 461.056 273.408 425.984 256 388.032 256H512z"/>
                                            </svg>
                                        ` : `
                                            <svg viewBox="0 0 1024 1024" width="20" height="20">
                                                <path d="M880 184H712v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H384v-64c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v64H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V216c0-17.7-14.3-32-32-32zM648.3 426.8l-87.7 161.1h45.7c5.5 0 10 4.5 10 10v21.3c0 5.5-4.5 10-10 10h-63.4v29.7h63.4c5.5 0 10 4.5 10 10v21.3c0 5.5-4.5 10-10 10h-63.4V752c0 5.5-4.5 10-10 10h-41.3c-5.5 0-10-4.5-10-10v-51.8h-63.1c-5.5 0-10-4.5-10-10v-21.3c0-5.5 4.5-10 10-10h63.1v-29.7h-63.1c-5.5 0-10-4.5-10-10v-21.3c0-5.5 4.5-10 10-10h45.2l-88-161.1c-2.6-4.8-.9-10.9 4-13.6 1.5-.8 3.1-1.2 4.8-1.2h46c3.8 0 7.2 2.1 8.9 5.5l72.9 144.3 73.2-144.3c1.7-3.4 5.2-5.5 8.9-5.5h45c5.5 0 10 4.5 10 10 0 1.7-.4 3.3-1.2 4.8z"/>
                                            </svg>
                                        `}
                                    </div>
                                    <h3>${reminder.title}</h3>
                                </div>
                                <span class="status ${reminder.status === 0 ? 'pending' : 'completed'}">
                                    ${reminder.status === 0 ? 'å¾…æé†’' : 'å·²æé†’'}
                                </span>
                            </div>
                            <div class="card-content">
                                <p class="content-text">${reminder.content}</p>
                                <p class="time-text">
                                    <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                        <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
                                        <path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"/>
                                    </svg>
                                    ${formatDateTime(reminder.remind_time)}
                                </p>
                                ${nextRemindTime ? `
                                <p class="time-text next-remind">
                                    <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                        <path d="M908.1 353.1l-253.9-36.9L540.7 86.1c-3.1-6.3-8.2-11.4-14.5-14.5-15.8-7.8-35-1.3-42.9 14.5L369.8 316.2l-253.9 36.9c-7 1-13.4 4.3-18.3 9.3a32.05 32.05 0 0 0 .6 45.3l183.7 179.1-43.4 252.9a31.95 31.95 0 0 0 46.4 33.7L512 754l227.1 119.4c6.2 3.3 13.4 4.4 20.3 3.2 17.4-3 29.1-19.5 26.1-36.9l-43.4-252.9 183.7-179.1c5-4.9 8.3-11.3 9.3-18.3 2.7-17.5-9.5-33.7-27-36.3z"/>
                                    </svg>
                                    ä¸‹æ¬¡æé†’: ${formatDateTime(nextRemindTime)}
                                </p>
                                ` : reminder.cycle_type === 'once' ? `
                                <p class="time-text next-remind disabled">
                                    <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                        <path d="M685.4 354.8c0-4.4-3.6-8-8-8l-66 .3L512 465.6l-99.3-118.4-66.1-.3c-4.4 0-8 3.5-8 8 0 1.9.7 3.7 1.9 5.2l130.1 155L340.5 670a8.32 8.32 0 0 0-1.9 5.2c0 4.4 3.6 8 8 8l66.1-.3L512 564.4l99.3 118.4 66 .3c4.4 0 8-3.5 8-8 0-1.9-.7-3.7-1.9-5.2L553.5 515l130.1-155c1.2-1.4 1.8-3.3 1.8-5.2z"/>
                                        <path d="M512 65C264.6 65 64 265.6 64 513s200.6 448 448 448 448-200.6 448-448S759.4 65 512 65zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
                                    </svg>
                                    å•æ¬¡æé†’æ— ä¸‹æ¬¡æé†’
                                </p>
                                ` : `
                                <p class="time-text next-remind waiting">
                                    <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                        <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
                                        <path d="M508 280c-4.4 0-8 3.6-8 8v284c0 4.4 3.6 8 8 8h284c4.4 0 8-3.6 8-8s-3.6-8-8-8H516V288c0-4.4-3.6-8-8-8z"/>
                                    </svg>
                                    ç­‰å¾…ç¬¬ä¸€æ¬¡æé†’åæ˜¾ç¤ºä¸‹æ¬¡æ—¶é—´
                                </p>
                                `}
                                <p class="cycle-text">
                                    <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                        <path d="M909.1 209.3l-56.4 44.1C775.8 155.1 656.2 92 521.9 92 290 92 102.3 279.5 102 511.5 101.7 743.7 289.8 932 521.9 932c181.3 0 335.8-115 394.6-276.1 1.5-4.2-.7-8.9-4.9-10.3l-56.7-19.5c-4.1-1.4-8.6.7-10.1 4.8-1.8 5-3.8 10-5.9 14.9-17.3 41-42.1 77.8-73.7 109.4-31.6 31.6-68.4 56.4-109.3 73.8-42.3 17.9-87.4 27-133.8 27-46.5 0-91.5-9.1-133.8-27-40.9-17.3-77.7-42.1-109.3-73.8-31.6-31.6-56.4-68.4-73.7-109.4-17.9-42.4-27-87.4-27-133.9s9.1-91.5 27-133.9c17.3-41 42.1-77.8 73.7-109.4 31.6-31.6 68.4-56.4 109.3-73.8 42.3-17.9 87.4-27 133.8-27 46.5 0 91.5 9.1 133.8 27 40.9 17.3 77.7 42.1 109.3 73.8 9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47c-5.3 4.1-3.5 12.5 3 14.1l175.6 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c-.1-6.6-7.8-10.3-13-6.2z"/>
                                    </svg>
                                    ${cycleText}&nbsp&nbspÂ¥${monthlyAmount.toFixed(2)}/Month&nbsp&nbspÂ¥${yearlyAmount.toFixed(2)}/Year
                                </p>
                            </div>
                            <div class="card-actions">
                                <a href="${reminder.link}" class="link-btn" target="_blank" rel="noopener noreferrer">
                                    <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                        <path d="M853.333333 469.333333a42.666667 42.666667 0 0 0-42.666666 42.666667v256a42.666667 42.666667 0 0 1-42.666667 42.666667H256a42.666667 42.666667 0 0 1-42.666667-42.666667V256a42.666667 42.666667 0 0 1 42.666667-42.666667h256a42.666667 42.666667 0 0 0 0-85.333333H256a128 128 0 0 0-128 128v512a128 128 0 0 0 128 128h512a128 128 0 0 0 128-128v-256a42.666667 42.666667 0 0 0-42.666667-42.666667z"/>
                                        <path d="M682.666667 213.333333h67.413333l-268.373333 267.946667a42.666667 42.666667 0 0 0 0 60.586667 42.666667 42.666667 0 0 0 60.586666 0L810.666667 273.92V341.333333a42.666667 42.666667 0 0 0 85.333333 0V170.666667a42.666667 42.666667 0 0 0-42.666667-42.666667h-170.666666a42.666667 42.666667 0 0 0 0 85.333333z"/>
                                    </svg>
                                    ç›´è¾¾é“¾æ¥
                                </a>
                                <button class="delete-btn" onclick="deleteReminder('${reminder.id}', '${reminder.cron_job_id}')">
                                    <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                        <path d="M360 184h-8c4.4 0 8-3.6 8-8v8h304v-8c0 4.4 3.6 8 8 8h-8v72h72v-80c0-35.3-28.7-64-64-64H352c-35.3 0-64 28.7-64 64v80h72v-72z"/>
                                        <path d="M864 256H160c-17.7 0-32 14.3-32 32v32c0 4.4 3.6 8 8 8h60.4l24.7 523c1.6 34.1 29.8 61 63.9 61h454c34.2 0 62.3-26.8 63.9-61l24.7-523H888c4.4 0 8-3.6 8-8v-32c0-17.7-14.3-32-32-32zM731.3 840H292.7l-24.2-512h487l-24.2 512z"/>
                                    </svg>
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    `;
                    listElement.appendChild(reminderElement);
                });
            } catch (error) {
                console.error('Error:', error);
                showToast('åŠ è½½æé†’åˆ—è¡¨å¤±è´¥ï¼š' + error.message, 'error');
            }
        }



        // æ·»åŠ æ¨¡æ€çª—å£ç›¸å…³çš„ä»£ç 
        const modal = document.getElementById('addFormModal');
        const openBtn = document.getElementById('openAddForm');
        const closeBtn = document.getElementsByClassName('close')[0];

        openBtn.onclick = function () {
            modal.style.display = "block";
        }

        closeBtn.onclick = function () {
            closeModal();
        }

        function closeModal() {
            modal.style.display = "none";
            document.getElementById('reminderForm').reset();
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('reminderForm').addEventListener('submit', addReminder);

        // åˆå§‹åŠ è½½
        loadReminders();

        // è®¾ç½®datetime-localçš„æœ€å°å€¼ä¸ºå½“å‰æ—¶é—´
        const remindTimeInput = document.getElementById('remindTime');
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        remindTimeInput.min = now.toISOString().slice(0, 16);

        // æ·»åŠ å¯†ç éªŒè¯ç›¸å…³å‡½æ•°
        async function verifyPassword() {
            const password = document.getElementById('password-input').value;
            try {
                const response = await fetch('/api/verify-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    document.getElementById('password-overlay').style.display = 'none';
                    document.body.classList.remove('locked'); // ç§»é™¤é”å®š
                    // è®¾ç½®cookieï¼Œæœ‰æ•ˆæœŸ30å¤©
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + 30);
                    document.cookie = `auth=true; expires=${expiryDate.toUTCString()}; path=/`;
                } else {
                    alert('å¯†ç é”™è¯¯');
                }
            } catch (error) {
                alert('éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ£€æŸ¥cookie
        window.onload = function () {
            // å¦‚æœå·²ç»æœ‰ auth cookieï¼Œç›´æ¥ç§»é™¤é”å®šçŠ¶æ€
            if (document.cookie.includes('auth=true')) {
                document.getElementById('password-overlay').style.display = 'none';
                document.body.classList.remove('locked');
                return; // ç›´æ¥è¿”å›ï¼Œä¸å†è¿›è¡ŒéªŒè¯
            }

            // åªæœ‰åœ¨æ²¡æœ‰ auth cookie çš„æƒ…å†µä¸‹æ‰æ£€æŸ¥å¯†ç 
            fetch('/api/verify-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password: '' })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // å¦‚æœæœåŠ¡å™¨æ²¡æœ‰è®¾ç½®å¯†ç ï¼Œç›´æ¥è®¾ç½®cookie
                        const expiryDate = new Date();
                        expiryDate.setDate(expiryDate.getDate() + 30);
                        document.cookie = `auth=true; expires=${expiryDate.toUTCString()}; path=/`;
                        document.body.classList.remove('locked');
                    } else {
                        // å¦‚æœéœ€è¦å¯†ç ä¸”æ²¡æœ‰éªŒè¯è¿‡ï¼Œæ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
                        document.getElementById('password-overlay').style.display = 'flex';
                        document.body.classList.add('locked');
                    }
                })
                .catch(error => {
                    console.error('Error checking password requirement:', error);
                });
        }
    </script>
</body>

</html>
